name: Publish
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  publish:
    runs-on: windows-2022
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET Core SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x.x'

    - name: Check if commit is tagged
      shell: pwsh
      run: |
        $tag = git describe --exact-match --tags HEAD 2>$null
        if (-not $tag) {
          Write-Output "::error:: This is a development build and should not be released. Did you forget to create a new tag for the release?"
          exit 1
        }
        Write-Output "Current commit is tagged with: $tag"
        # Extract version from tag (remove 'v' prefix if present)
        $version = $tag -replace '^v', ''
        echo "VERSION_TAG=$tag" >> $env:GITHUB_ENV
        echo "VERSION=$version" >> $env:GITHUB_ENV

    - name: Publish
      run: dotnet publish --framework net40 --configuration Release -p:DebugType=embedded -p:AssemblyVersion=$env:VERSION -p:FileVersion=$env:VERSION -p:InformationalVersion=$env:VERSION

    - name: Zip
      run: 7z a -r ${{ format('CnCNet.LauncherStub-{0}-net40.zip', env.VERSION_TAG) }} ./bin/Release/net40/publish/*.*

    - name: Create Release
      shell: pwsh
      run: |
        # Check if version contains prerelease markers (-, alpha, beta, rc, etc.)
        $isPrerelease = $env:VERSION -match '-'
        
        if ($isPrerelease) {
          Write-Output "Creating prerelease for $env:VERSION_TAG"
          gh release create $env:VERSION_TAG (get-item *.zip) --generate-notes --target ${{ github.sha }} --prerelease
        } else {
          Write-Output "Creating release for $env:VERSION_TAG"
          gh release create $env:VERSION_TAG (get-item *.zip) --generate-notes --target ${{ github.sha }}
        }
      env:
        GH_TOKEN: ${{ github.token }}